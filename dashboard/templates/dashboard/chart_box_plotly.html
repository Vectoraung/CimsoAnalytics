<div class="chart-box{{exception}}">
    <div class="collapse" id="{{chart.chartId}}-filter-view" style="height: 150px;width: 100%;max-width: 100%;">
        <div class="card card-body" style="height: 150px;overflow-y: scroll;width: 100%;max-width: 100%;">
            {% if chart.filters %}
            <form id="{{chart.chartId}}-filterForm" class="filter-form">
                {% for filter in chart.filters %}
                    <div class="form-group">
                        <label for="{{ filter.name }}">{{ filter.label }}</label>
                        
                        {% if filter.type == "date" %}
                            <input type="date" name="{{ filter.name }}" id="{{ filter.name }}" value="{{ filter.default }}">
                        
                        {% elif filter.type == "select" %}
                            <select name="{{ filter.name }}" id="{{ filter.name }}">
                                {% for option in filter.options %}
                                    <option value="{{ option.value }}" {% if option.value == filter.default %}selected{% endif %}>
                                        {{ option.label }}
                                    </option>
                                {% endfor %}
                            </select>

                        {% elif filter.type == "radio" %}
                            <div class="filter-radio-group">
                                {% for option in filter.options %}
                                    <label class="filter-radio-label">
                                        <input type="radio" name="{{ filter.name }}" value="{{ option.value }}"
                                            {% if option.value == filter.default %}checked{% endif %}>
                                        <span class="filter-custom-radio"></span> {{ option.label }}
                                    </label>
                                {% endfor %}
                            </div>
                        
                        {% elif filter.type == "number" %}
                            <input type="number" name="{{ filter.name }}" id="{{ filter.name }}" value="{{ filter.default }}">
                        
                        {% endif %}
                    </div>
                {% endfor %}
                
                <button type="submit" class="btn btn-primary">
                    Apply
                </button>
            </form>
        {% else %}
            <p>No filters available.</p>
        {% endif %}
        </div>
      </div>
    <div class="toolbar-container">
        {% if chart.type == 'chart' %}
        <button class="btn" type="button" onclick="zoomIn('{{chart.chartId}}');">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-zoom-in" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11M13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0"/>
            <path d="M10.344 11.742q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1 6.5 6.5 0 0 1-1.398 1.4z"/>
            <path fill-rule="evenodd" d="M6.5 3a.5.5 0 0 1 .5.5V6h2.5a.5.5 0 0 1 0 1H7v2.5a.5.5 0 0 1-1 0V7H3.5a.5.5 0 0 1 0-1H6V3.5a.5.5 0 0 1 .5-.5"/>
          </svg>
        </button>
        <button class="btn" type="button" onclick="zoomOut('{{chart.chartId}}');">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-zoom-out" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11M13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0"/>
            <path d="M10.344 11.742q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1 6.5 6.5 0 0 1-1.398 1.4z"/>
            <path fill-rule="evenodd" d="M3 6.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5"/>
          </svg>
        </button>
        <button class="btn" type="button" onclick="resetChart('{{chart.chartId}}');" id="{{chart.chartId}}-reset-size">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
          </svg>
        </button>
        <button class="btn" type="button" onclick="saveChartAsImage('{{chart.chartId}}');">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-arrow-down" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M7.646 10.854a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 9.293V5.5a.5.5 0 0 0-1 0v3.793L6.354 8.146a.5.5 0 1 0-.708.708z"/>
            <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383m.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/>
          </svg>
        </button>
        {% endif %}
        <button class="btn" type="submit" form="{{ chart.chartId }}-filterForm" id="{{ chart.chartId }}-refresh">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
              </svg>
        </button>
        <button class="btn" type="button" id="{{ chart.chartId }}-filter" data-bs-toggle="collapse" data-bs-target="#{{chart.chartId}}-filter-view" aria-expanded="false" aria-controls="{{chart.chartId}}-filter-view">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filter" viewBox="0 0 16 16">
                <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/>
            </svg>
        </button>
        <button class="btn" type="button" id="{{ chart.chartId }}-generate-report" onclick="generateReport('{{chart.title}}');">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
            <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
          </svg>
        </button>
    </div>
    {% if chart.type == 'single_value' %}
    <div class="single-value-chart-title text-center fw-semibold lh-1" id="{{ chart.chartId }}-title">
        {{ chart.title }}
    </div>
    <p class="fw-bold single-value-chart-value lh-1" style="color: #419fe3" id="{{ chart.chartId }}">
    </p>
    {% elif chart.type == 'chart' %}
    <div class="single-value-chart-title text-center fw-semibold lh-1" id="{{ chart.chartId }}-title">
        {{ chart.title }}
    </div>
    <div class="chart-container" id="{{chart.chartId}}"></div>
    {% elif chart.type == 'table' %}
    <div class="single-value-chart-title text-center fw-semibold lh-1" id="{{ chart.chartId }}-title">
        {{ chart.title }}
    </div>
    <div class="chart-container" id="{{chart.chartId}}" style="overflow-y: scroll;"></div>
    {% endif %}
</div>

<script>
async function fillChart_{{chart.chartId}}(formData){
  try {
    showLoadingSpinner("{{chart.chartId}}"); // Show loading spinner before fetching data
    const response = await fetch('{{chart.data_url}}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(), // Include CSRF token for security
      },
      body: JSON.stringify({title: "{{chart.title}}", formData: formData}),
    });
    const data = await response.json();

    {% if chart.type == 'single_value' %}
    
    createSingleValueChart("{{chart.chartId}}-title", "{{chart.chartId}}", "{{chart.title}}", data.data);

    {% elif chart.type == 'chart' %}

    createChart("{{chart.chartId}}", "{{chart.title}}", data.data, data.titles, data?.additional_layout_config ?? null);

    {% elif chart.type == 'table' %}

    createTable("{{chart.chartId}}", data.data);

    {% endif %}

  } catch (error) {
    console.error('Error fetching arrivals data:', error);
  }
}

// Add event listener to filter form
if (document.getElementById('{{ chart.chartId }}-filterForm')) {
    document.getElementById('{{ chart.chartId }}-filterForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(event.target);
        const jsonData = JSON.stringify(Object.fromEntries(formData));

        await fillChart_{{chart.chartId}}(jsonData);
    });
}
</script>